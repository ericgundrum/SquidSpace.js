# SquidSpace.js Pack Files 

SquidSpace.js Pack Files are JSON data used as inputs to several of the SquidSpace.js tools. In particular they are inputs to the SquidSpace.js tools to manage the asset pipeline and to generate runtime Javascript.

All Pack Files must conform to the (Pack File Specification)[packfile-specification.md]. However, that specification does not specify the content values of configuration, options, and data subsections of the different object types; leaving that to the implementation. In general, configuration ("config") sections are used by tools that read and use Pack Files to do work. Options ("options") and Data ("data") subsections are used by the runtime API and are usually passed through by the tools unchanged or with minimal modification.

This document specifies the configuration values supported by the SquidSpace.js tools. For more details on the tools please see the (tool documentation)[squidspace-tools.md]. It also specifies the options and data values used by the runtime SquidSpace.js API. For more details on the runtime API please see the (API reference)[squidspace-api.md]. 

This document is organized by "levels", starting from the top-level of the file and then drilling down through sections. The (Pack File Specification)[packfile-specification.md] details how the sections are organized and what values they may contain; this document only specifies the contents of the "config", "options" and "data" subsections of each section/object type level and is specific to SquidSpace.js.

## How Pack Files are Used

Pack Files may be used in a number of ways by different SquidSpace.js tools and by third-party tools. The two most common usages are Code Generation and Asset Pipeline Management.

### Code Generation

The Pack File is used as input to a packer, which then generates some sort of application-specific code. The SquidSpace "spacepacker" utility generates an older-style javascript module, which allows loading without being blocked by CORS when the requesting HTML file is opened from a file system. If you "insert"
all of your 3D content into the generated modules you can run SquidSpace without requiring a web server. 

For more details on the module file interface generated by spacepacker, see the SquidSpace documentation. 

NOTE: It is possible to create your own SquidSpace content modules from scratch or to edit generated SquidSpace content modules. However, pack files are almost certainly simpler to use.

### 3D Asset Pipeline Management

TODO

## SquidSpace.js-Specific Pack File Values

SquidSpace.js supports some special data values to extend the capapabilities of Pack Files. These include Hook Function References and Event Subsections.

### Hook Function References

SquidSpace.js supports 'Hook Functions' that extend different classes of functionality. For some of these functionality classes the Hook Functions are named, in which case the that name may be referenced in the Pack File data to use instead of the native SquidSpace.js functionality for that functionality class. There are also unnamed hook functions that are not referenced in the Pack File but may invisibly modify SquidSpace.js behavior at runtime or when processing the Pack File. For more detail on Hook Functions see the (SquidSpace.js API documentation)[squidspace-api.md] and the (SquidSpace.js Hooks documentation)[squidspace-hooks.md].

When something in a Configuration requires a Hook Function to be specified for code generation, for example if the "action" configuration value for a resource type is "hook", then the named Hook Function to use *must* be specified with a Hook Function Reference in the same configuration. The name for a Hook Function Reference is always "hook".

In some cases a Hook Function may be specified for runtime use, in which case it is always specified in the Options section using the name "hook".

Examples:

	"objects": [
		{
			"name": "foo",
			"config": {
				"action": "hook",
				"hook": "fooLoader"
				. . . Other object configuration values.
			},
			. . . Other object values.
		},
	],

	"lights": [
		{
			"name": "bar",
			"options": {
				"hook": "barFader"
				. . . Other light objects values.
			},
			. . . Other light values.
		},
	],

### Events Subsections

Certain Pack File sections may contain an "events" subsection in their "options" section. Each Event is specified by an event type and name and and what event types are available are context dependent. If a section supports events the allowed event types are detailed in this document. For more detail on Events see the (SquidSpace.js API documentation)[squidspace-api.md] and the (SquidSpace.js Events documentation)[squidspace-events.md].

Pack File sections currently supporting Events in their options are:

* Modules – 'World' modules can specify World-level events
	- TODO: Keypress events?

* Layout Areas - Each layout area can specify events related to objects and the area boundaries
	- TODO: List of layout area events

* Object Placements – Each object placement can specify events for that object when it is placed
	- "on-click": Makes the object clickable and fires related events when the object is clicked
	- TODO: Others

The Events subsection is a JSON array of Event JSON objects, each containing the following named values:

* "event" – [string; required] – Specifies the name to which all Event handlers for this event are bound

* "options" - [object; optional] – Contains options values passed to all handlers for the event at runtime when the Event is triggered

* "data" - [any type; optional] – Contains data passed to all handlers for the event at runtime when the Event is triggered

For example, if an 'on-click' event is attached to an object in the layout object placements (see below), the Events subsection of the Object's options might look like this:

	{
		"object": "foo-object",
		"options": {
			"events": {
				"on-click": [
					{
						"event": "foo-click-event",
						"options": {
							"foo": "bar",
							"count": 3
						},
						"data": "bar"
					}
				]
			}
			. . . Other object placement option values.
		}
		. . . Other object placement values.
	}

If the user then clicks the "foo-object" object at runtime, every event handler assigned to "foo-click-event" is called in turn using the arguments `("foo-object", {"foo": "bar","count": 3}, "bar")`.

## Top (Global) Level 

The Top level of the file contains global values applying to the whole file. Besides the "config", "options" and "data" subsections the Top level contains a Modules ("modules") subsection. 

### Global Configuration

* "js-outdir" – [optional, string] – Directory to write output Javascript output modules to, used by the spacepack tool; can be overridden for individual modules; default value depends on the tool reading the Pack File

* "js-indir" – [optional, string] – Directory containing mods or other Javascript files to import; can be overridden for individual mods; default value depends on the tool reading the Pack File

* "texture-dir" – [optional, string] – Directory containing textures to import; can be overridden for individual textures; default value depends on the tool reading the Pack File

* "material-dir" – [optional, string] – Directory containing materials to import; can be overridden for individual materials; default value depends on the tool reading the Pack File

* "object-dir" – [optional, string] – Directory containing objects to import; can be overridden for individual objects; default value depends on the tool reading the Pack File

* "pretty-print" – [optional, boolean, default is false] – If true, all module not specifying otherwise are formatted to be readable, using the "pretty-offset" value for formatting; if false the module is "packed"; can be overridden for individual modules

* "pretty-offset" – [optional, positive integer or zero, default is "3"] – The number of spaces to offset when pretty printing; can be overridden for individual modules

### Global Options

None at this time.

### Global Data

None at this time.

## Modules

Modules are an array of Module JSON objects specified with the key "modules" from the Top level. Besides the "config", "options" and "data" subsections Modules contain Resources ("resources"), Layouts ("layouts"), and Wiring ("wiring") subsections. 

### Module Configuration

* "is-world" – [optional, boolean, default is 'false'] – If true, indicates the module contains a world specification, which may have different processing and can include different data

* "pretty-print" – [optional, boolean, default is false] – If true, the module is formatted to be readable, using the "pretty-offset" value for formatting; if false the module is "packed"

* "pretty-offset" – [optional, positive integer or zero, default is "3"] – The number of spaces to offset when pretty printing

### Module Options

Module options must be of type JSON object. The following named values are supported:

* "world-origin" – [optional if config:is-world is true, otherwise do not use, array of x, y, z values] Used to specify the NW corner of the world as an origin point; defaults to [0, 0, 0]

TODO: World-level events, such as "on-keypress".

### Module Data

None at this time.

## Resources

Resources are JSON objects that contain none, some, or all of Textures ("textures"), Materials ("materials"), Objects ("objects"), and Lights ("lights") subsections. Resources do not contain "config", "options" and "data" subsections.

### Standard Resource Configuration

All resource configuration subsections provide the following standard resource configuration values:

* "dir" – [optional, string] – Directory containing resource to import; overrides the global 'dir' value for the resource section

* "action" – [required, string, one of "insert", "link", "cache", or a Hook String] – Specifies the action to take for the resource
	- "insert" – The referenced resource data is copied into the generated output file; forces caching when managing asset pipelines
	- "link" – The referenced resource data is always loaded at runtime from a URL; results in no action by asset pipelines and the data is served via the URL
	- "cache" – The referenced resource data is always loaded at runtime from a URL; the asset pipeline will copy the data to a local cache to be served from there
	- "hook" – The referenced resource data is a 'Resource Loader Hook' provided by SquidSpace.js or by a loaded mod; the Hook Name itself is arbitrary and must refer to an attached resource Builtin Hook Function 
	
* "hook" – [required if the "action" value is "hook", otherwise do not use, string] – References the Resource Loader Hook Function to use to load the resource; the hook function will be passed the options and data sections for the resource at runtime

NOTE: Resource Loader Hooks allow for pre-defined resources (builtins) which are created from code or otherwise outside of the regular resource loading functionality. For more detail on Hook Functions see the (SquidSpace.js API documentation)[squidspace-api.md] and the (SquidSpace.js Hooks documentation)[squidspace-hooks.md]

### Standard Resource Options

There are no standard resource options subsection values at this time. Some resource types have standard options and builtins may require certain specified options.

If the configuration "action" value is "hook" the options data subsection may contain any values expected by the Hook Function.

### Standard Resource Data

If the configuration "action" value is "hook" a resource data subsection may contain any values expected by the Hook Function.

For all other configuration "action" values the resource data subsection values are either JSON strings or Expression Strings.

If the value is a standard JSON string it is either a file reference or, if the configuration "action" value is "link", it is a URL. 

If the value is an Expression String it is either an expression returning a URL or, if the configuration "action" value is "insert", it is the actual data to insert.

## Textures

Textures are an array of Texture JSON objects specified with the key "textures" from the Module/Resources level. Textures do not have subsections other than "config", "options", and "data".

### Texture Configuration

Texture resources support the Standard Resource Configuration.

### Texture Options

Texture resources support the Standard Resource Options, plus the following if the configuration "action" value is not "hook":

* "type" – [required if the "action" is "insert" and the data is an Expression String, otherwise do not use, string] – Specifies the file type of the texture resource in the form of a file name extension; for example '.png', '.jpeg', etc.

If the configuration "action" value is "hook", the options may contain values dependent on the Resource Loader Hook Function specified in the configuration.

### Texture Data

Texture data consists of image data that will be applied to a material, using the material name, as a texture.

Texture resources support the Standard Resource Data using a standard image data type. Currently SquidSpace.js only supports data for non builtin textures.

## Materials

Materials are an array of Material JSON objects specified with the key "materials" from the Module/Resources level. Materials do not have subsections other than "config", "options", and "data".

### Material Configuration

Material resources support the Standard Resource Configuration, except the only allowed action is a Builtin Hook Name.

At this time Materials do not have a data type that can be specified for inserting or loaded via a URL. All materials are 'builtins' specified with Resource Loader Hook Function and their option and data values are dependent on the named Resource Loader Hook Function in the configuration.

### Material Options

Material resources support the Standard Resource Options. They may contain values dependent on the Resource Loader Hook Function specified in the configuration.

TODO: Specify the SquidSpace builtin materials.

### Material Data

Material resource data values and types are dependent on the Resource Loader Hook Function specified in the configuration.

## Objects

Modules are an array of 3D Object JSON objects specified with the key "objects" from the Module/Resources level. Objects do not have subsections other than "config", "options", and "data".

### Object Configuration

Object resources support the Standard Resource Configuration.

### Object Options

Object resources support the Standard Resource Options, plus the following if the configuration "action" value is not "hook":

* "space-object" – [optional, default is false] – Specifies that the object is  made visible in the space at startup using the object's own position data; otherwise the object is a "layout object" and is made invisible in the space at startup and must be placed into the space using a layout (see also, Area  Layouts below)

The following options values are specific to "object" sections:

* "loader" – [required if the action is "insert" or "link" and the object file type is not ".babylon", otherwise do not use] – Used to specify the Babylon.js object loading plugin to use by file name extension; currently supported loader values include:
	 - ".obj"
	 - TODO: Research what filename extensions Babylon.js loaders support and add here

If the configuration "action" value is "hook", the options may contain values dependent on the Resource Loader Hook Function specified in the configuration.

Object options may also contain an "events" section, specifying options and data for the following event types:

* "on-click" – Makes object clickable in the 3D space

TODO: Other supported events.

### Object Data

Object data consists of all the geometry/meshes for a single object added to the space.

Object resources support the Standard Resource Data using a standard 3D object type. Currently SquidSpace.js only supports data for non builtin 3D objects.

## Lights

Lights are an array of Light JSON objects specified with the key "lights" from the Module/Resources level. Lights do not have subsections other than "config", "options", and "data".

At this time lights do not have a data type that can be specified for inserting or loaded via a URL. All lights are 'builtins' specified with Resource Loader Hook Function and their option and data values are dependent on the named Resource Loader Hook Function in the configuration.

### Light Configuration

Light resources support the Standard Resource Options. They may contain values dependent on the Resource Loader Hook Function specified in the configuration.

### Light Options

Light resource data values and types are dependent on the Resource Loader Hook Function specified in the configuration.

### Light Data

Light resource data values and types are dependent on the Resource Loader Hook Function specified in the configuration.

## Layouts

Layouts are JSON arrays containing a list of Layout Area JSON objects. Layouts do not contain "config", "options" and "data" subsections.

## Layout Areas

Layout Areas are JSON objects specifying a single area within the 3D space, each of which contain zero or more 'object placements' specifying what objects the Layout Area contains and where they are located. Layout areas are dimennsioned as rectangular with a width and depth and specified with an origin point based off of the world origin. 

Layout Areas are singlular and contiguous, but may overlap with other Layout Areas. The object placements they contain use the layout area origin point when placing 'standalone' objects, but do not need to be located within the Layout Area.

### Layout Area Configuration

None at this time.

### Layout Area Options

Layout Area options must be of type JSON object. The following named values are supported:

* "origin" – [required if the Layout Area is included in a World specification module, required if specifying a Layout Area not also specified in a World specification module, otherwise do not use; array of x, y, z values] Used to specify the NW corner of the Layout Area as an origin point, based on the World origin point

* "events" – [optional ]

TODO: Layout Area-level events, such as "on-keypress", "on-user-enter/leave", etc.

NOTE: If the origin is specified for a Layout Area of the same name in the World specification module and in a separate module for a Layout Area of the same name, the "origin" value from the World specification module is used and the separate module's "origin" value is ignored.

NOTE: A common use case is to declare Layout Areas with no or few object placements in a World specification module and then re-use those named Layout Areas in other modules, adding other object placements.

### Layout Area Data

None at this time.

## Object Placements

Object Placements are JSON objects specifying zero or more 'placements' for a single object within a Layout Area, each of which contain zero or more 'placements' specifying the places that object is located. 

Object Placements specify a named object, which must have been loaded as a resource in the current module, loaded as a resource in a separate module belonging to the same world, or included as a 'builtin' by the runtime. All of the contained placements are for the same object using the same Object Placement options.

WARNING! Specifying an object name that is not loaded results in undefined behavior. 

### Object Placement Configuration

None at this time.

### Object Placement Options

* "materials" – [optional, JSON array] – Specifies zero or more materials and the named submeshes to apply the materials to:
	- "material" – [required, name of a loaded material] - Specifies the material to use
	- "submesh" – [optional, name of a submesh within the object] – Specifies applying the named material to a named submesh; if not provided the material is applied to all submeshes

* "events" – [optional, Events subsection] – Specifies one or more events applying to all object placements

The Materials option specify a named material, which must have been loaded as a resource in the current module, loaded as a resource in a separate module belonging to the same world, or included as a 'builtin' by the runtime. 

NOTE: Applying materials to an Object Placement creates a 'clone' of the named object and all placements are instances of that clone. If no materials are applied all placements are instances of the original object. Generally clones create more geometry in the World space and use more memory and other runtime resources, so they should be avoided if possible.

WARNING! Specifying a material name that is not loaded results in undefined behavior. 

WARNING! Specifying multiple materials for the same submesh results in undefined behavior. 

### Object Placement Data

None at this time.

## Placements

Placements are JSON objects specifying the location in the World space of an instance of the object specified in the containing Object Placement. Each Placement must specify a named "placer" algorithm to use, which must be a SquidSpace.js builtin placer or a 'Placer Hook' loaded from a mod. Placements must also specify a unique "place-name" used within the Layout Area for the object instance(s) being placed. 

NOTE: If a placer algorithm results in multiple instances of the object, the instances are named using the "place-name" specified, with a dash ('-') and a number appended, where that number is zero to the number of instances placed minus one.

### Placement Configuration

None at this time.

### Placement Options

The Placement options are dependent on the placer algorithm. Some builtin placer algorithms have specific options and if the placer algorithms specified is for a 'placer hook' the data subsection may contain any values expected by the Hook Function.

Standard option values for all Placer Algorithms, both builtins and 'placer hook functions' include:

* "position" – [optional; array of x, y, z values, defaults to [0, 0, 0]] – Specifies the position of the placed object; if "place-on-object" is not specified the position is based on the Layout Area's origin, otherwise the position is based on the named submesh's origin (TODO: Find out Babylon.js standard origin point for submeshes); see below for "place-on-object" values

* "rotation" – [optional; number value specifying the rotation of all placed objects for a placement, defaults to 0]

All SquidSpace.js builtins and some 'placer hook functions' also support:

* "place-on-object" – [optional; the name of an object previously placed in the World Space within the same Layout Area] – Specifies an object to place an instance of this Object Placement on

* "place-on-submesh" – [required if "place-on-object" is specified, otherwise do not use; A submesh of the object specified with the "place-on-object" value

NOTE: A common submesh naming pattern for objects which will have other objects placed on them is to use 'top', 'bottom', 'left', 'right', 'front', and 'back' if possible. 

WARNING: "place-on-object" values are dependent on object loading order. This is determined by the order in which the pack file modules are passed to SquidSpace.js, where the first module loaded is *always* the World specification module, after which other pack file modules are loaded in an order specified when SquidSpace.js is initialized at runtime.

TODO: Find a way to remove the loading order issue. One option is to defer on-object placements until all objects are placed, but that raises the issue of what happens when you place an object on an object placed on another object.

For other possible placement option values, see Builtin Placer Algorithms below.

### Placement Data

There are no standard Placement data subsection values at this time. If the placer algorithms specified is for a 'placer hook' the data subsection may contain any values expected by the Hook Function.

### Builtin Placer Algorithms

SquidSpace.js includes a number of builtin placer algorithms, any of which may be overridden by a 'placer hook function' using the same name and using the same options. 

The builtin placer algorithms are:

* "single" – Places a single instance of an object in a particular location; requires only standard placement options values

* "linear-series" - Places a row of instances of an object starting from a particular location; requires the standard placement options values, plus:
	- "count" – [required; integer] – Specifies number of object instances to place in a row
	- "across" – [optional; boolean, default is true] – Specifies whether the series goes from lesser 'x' to a greater 'x' value (true) or from lesser 'z' to a greater 'z' value (false)
	- "offset" – [optional; number, default is '0'] – Specifies in size units the offset between objects when they are placed, if a negative value the objects may overlap

* "rectangle" - Places a rectangle of instances of an object starting from a particular location; requires the standard placement options values, plus:
	- "countWide" – [required; integer] – Specifies number of object instances to place in a row from lesser 'x' to a greater 'x' value
	- "countDeep" – [required; integer] – Specifies number of object instances to place in a row from lesser 'z' to a greater 'z' value
	- "lengthOffset" – [optional; number, default is '0'] – Specifies in size units the offset between objects along the 'x' axis when they are placed, if a negative value the objects may overlap
	- "widthOffset" – [optional; number, default is '0'] – Specifies in size units the offset between objects along the 'x' axis when they are placed, if a negative value the objects may overlap

NOTE: "linear-series" and "rectangle" placement objects only place along the 'x' and 'z' axis's. The 'y' axis is fixed from the placement's position.

TODO: Consider ways to do 'y' axis placement.

TODO: Determine if we need other builtin placement algorithms.

## Wirings

Wirings are JSON arrays containing a list of Modifier JSON objects. Wirings do not contain "config", "options" and "data" subsections.

## Modifiers

TODO



